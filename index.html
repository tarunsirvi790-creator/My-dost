<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cute AI Dost - Integrated Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/data/face-min.js"></script>
    <style>
        :root {
            --skin: #ffe0bd;
            --hair: #4b2c20;
            --shirt: #ffeb3b;
            --pink: #f472b6;
        }

        body {
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            overflow: hidden;
        }

        .character-stage {
            position: relative;
            width: 350px;
            height: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .head-group {
            position: relative;
            z-index: 10;
            transition: transform 0.1s linear; 
        }

        .head-base {
            width: 160px;
            height: 170px;
            background: var(--skin);
            border-radius: 80px 80px 65px 65px;
            position: relative;
            box-shadow: inset -10px -10px 25px rgba(0,0,0,0.15);
        }

        .bun {
            width: 70px;
            height: 70px;
            background: var(--hair);
            border-radius: 50%;
            position: absolute;
            top: -30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .bun-l { left: -15px; }
        .bun-r { right: -15px; }

        .eye-container {
            position: absolute;
            top: 65px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 30px;
        }
        .eye {
            width: 40px;
            height: 50px;
            background: white;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .pupil {
            width: 26px;
            height: 26px;
            background: #23110a;
            border-radius: 50%;
            position: relative;
            transition: transform 0.1s ease-out;
        }
        .pupil::after {
            content: '';
            position: absolute;
            width: 10px; height: 10px; background: white;
            border-radius: 50%; top: 4px; left: 4px;
        }
        .blink-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 0%;
            background: var(--skin);
            z-index: 5;
            animation: blink-anim 4s infinite;
        }
        @keyframes blink-anim {
            0%, 90%, 95%, 100% { height: 0%; }
            92.5% { height: 100%; }
        }

        .mouth-area {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mouth-shape {
            width: 24px;
            height: 6px;
            background: #e11d48;
            border-radius: 20px;
            transition: all 0.1s ease;
        }
        .is-speaking .mouth-shape {
            animation: mouth-sync 0.12s infinite alternate;
        }
        @keyframes mouth-sync {
            0% { height: 4px; width: 18px; }
            100% { height: 26px; width: 30px; border-radius: 40% 40% 30% 30%; }
        }

        .body-part {
            width: 120px;
            height: 130px;
            background: var(--shirt);
            border-radius: 50px 50px 20px 20px;
            margin-top: -15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 5;
        }

        #camVideo {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }

        .control-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #f472b6;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(244, 114, 182, 0.5);
        }

        .glow-active {
            box-shadow: 0 0 30px rgba(244, 114, 182, 0.4);
            animation: pulse-border 1.5s infinite alternate;
        }

        @keyframes pulse-border {
            from { border-color: rgba(244, 114, 182, 0.2); }
            to { border-color: rgba(244, 114, 182, 0.8); }
        }
    </style>
</head>
<body class="text-slate-100 min-h-screen font-sans flex flex-col items-center justify-center p-4">

    <!-- Camera Feed -->
    <video id="camVideo" width="320" height="240" preload autoplay loop muted></video>

    <!-- Status Banner -->
    <div id="spiritReminder" class="fixed top-6 flex items-center gap-2 text-[10px] bg-amber-500/10 text-amber-500 border border-amber-500/20 px-4 py-1.5 rounded-full font-bold tracking-widest uppercase animate-pulse">
        <i data-lucide="sun" class="w-3 h-3"></i> 9 PM Na Sadhana Mate Taiyar
    </div>

    <!-- Avatar Container -->
    <div id="characterStage" class="character-stage mb-4">
        <div class="head-group" id="headContainer">
            <div class="bun bun-l"></div>
            <div class="bun bun-r"></div>
            <div class="head-base">
                <div class="eye-container">
                    <div class="eye"><div class="blink-layer"></div><div class="pupil"></div></div>
                    <div class="eye"><div class="blink-layer"></div><div class="pupil"></div></div>
                </div>
                <div class="mouth-area">
                    <div id="mouthShape" class="mouth-shape"></div>
                </div>
            </div>
        </div>
        <div class="body-part"></div>
    </div>

    <!-- AI Voice Locked Indicator -->
    <div class="mb-4 flex items-center gap-2 px-3 py-1 bg-pink-500/10 border border-pink-500/20 rounded-full">
        <i data-lucide="lock" class="w-3 h-3 text-pink-400"></i>
        <span class="text-[9px] font-bold text-pink-400 uppercase tracking-widest">Aoede Voice Locked (Cute)</span>
    </div>

    <!-- Minimal Subtitle -->
    <div id="aiTextDisplay" class="text-center max-w-lg mb-6 h-14 text-xl font-semibold text-pink-300 opacity-0 transition-all duration-300 scale-95 drop-shadow-lg">
        "Tarun bhai, hu taiyar chu!"
    </div>

    <!-- Minimal Controls -->
    <div class="control-panel p-6 rounded-[2.5rem] flex flex-col items-center gap-6 shadow-2xl">
        <div class="flex items-center gap-10 w-full justify-center">
            <button id="micBtn" onclick="toggleMain()" class="w-20 h-20 rounded-full bg-gradient-to-tr from-pink-600 to-rose-500 flex items-center justify-center shadow-xl shadow-pink-500/20 active:scale-90 transition-all">
                <i data-lucide="mic" id="micIcon" class="w-8 h-8 text-white"></i>
            </button>
            
            <div class="flex flex-col gap-2 flex-1 max-w-[150px]">
                <span class="text-[9px] uppercase font-black text-slate-400 tracking-tighter">Bolvanu Samay (Time)</span>
                <input type="range" id="speechLength" min="15" max="120" value="50" class="range-slider appearance-none bg-slate-800 h-1.5 rounded-full outline-none">
                <div class="flex justify-between text-[8px] text-slate-500 font-black">
                    <span>CHOTU (Short)</span>
                    <span>MOTU (Long)</span>
                </div>
            </div>
        </div>

        <div class="flex gap-4 w-full justify-center">
            <button onclick="initCamera()" id="camBtn" class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-[9px] font-black uppercase tracking-widest hover:bg-indigo-500/20 transition-all">
                <i data-lucide="video" class="w-3.5 h-3.5 text-indigo-400"></i> Nazar Rakhvanu Shuru Karo
            </button>
            <div id="statusIndicator" class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-black/30 border border-white/5 text-[9px] font-black tracking-widest">
                <span id="dot" class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                <span id="stTxt" class="text-slate-500 uppercase">Standby</span>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let recognizer = null;
        let isRunning = false;
        let isSpeaking = false;
        let cameraStarted = false;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Voice Engine Module
        const STABLE_VOICE = "Aoede";

        function init() {
            lucide.createIcons();
            setupSTT();
            
            const hour = new Date().getHours();
            if (hour < 20 && hour > 2) document.getElementById('spiritReminder').style.display = 'none';
        }

        // Camera Tracking
        function initCamera() {
            const video = document.getElementById('camVideo');
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
                video.play();
                cameraStarted = true;
                document.getElementById('camBtn').innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-green-400"></i> Nazar Chalu Che';
                lucide.createIcons();
                startFaceTracker();
            }).catch(err => {
                console.error("Camera error");
            });
        }

        function startFaceTracker() {
            const video = document.getElementById('camVideo');
            const tracker = new tracking.ObjectTracker('face');
            tracker.setInitialScale(4); tracker.setStepSize(2); tracker.setEdgesDensity(0.1);
            tracking.track('#camVideo', tracker);
            tracker.on('track', event => {
                if (event.data.length > 0) {
                    const rect = event.data[0];
                    const x = (( (rect.x + rect.width / 2) / video.width) - 0.5) * -18;
                    const y = (( (rect.y + rect.height / 2) / video.height) - 0.5) * 18;
                    moveEyes(x, y);
                }
            });
        }

        function moveEyes(x, y) {
            const pupils = document.querySelectorAll('.pupil');
            const head = document.getElementById('headContainer');
            pupils.forEach(p => p.style.transform = `translate(${x}px, ${y}px)`);
            head.style.transform = `rotate(${x / 3}deg) translateY(${y / 4}px)`;
        }

        // Speech recognition
        function setupSTT() {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechAPI) return;
            recognizer = new SpeechAPI();
            recognizer.lang = 'hi-IN';
            recognizer.continuous = false;

            recognizer.onstart = () => {
                updateUI("Saambhalu chu", "bg-green-500");
                document.getElementById('aiTextDisplay').style.opacity = "0";
            };

            recognizer.onresult = (e) => {
                const text = e.results[0][0].transcript;
                
                // Python Script Commands Logic (Integrated)
                handlePythonCommands(text);
            };

            recognizer.onend = () => {
                if (isRunning && !isSpeaking) {
                    setTimeout(() => { if(isRunning && !isSpeaking) recognizer.start(); }, 600);
                }
            };
        }

        function handlePythonCommands(text) {
            const query = text.toLowerCase();
            
            if (query.includes("open youtube")) {
                window.open("https://www.youtube.com", "_blank");
                playStableVoice("YouTube kholi rahyu chu, maze karo!");
                return;
            }
            if (query.includes("open google")) {
                window.open("https://www.google.com", "_blank");
                playStableVoice("Google uncle hazir che!");
                return;
            }
            if (query.includes("open gmail")) {
                window.open("https://mail.google.com", "_blank");
                playStableVoice("Gmail kholi nakhyu!");
                return;
            }
            if (query.includes("search") || query.includes("search on google")) {
                const searchTerm = query.replace("search", "").replace("on google", "").trim();
                window.open(`https://www.google.com/search?q=${searchTerm}`, "_blank");
                playStableVoice(`${searchTerm} mate Google kari rahi chu.`);
                return;
            }

            // Default Gemini Response
            getAIResponse(text);
        }

        async function getAIResponse(input) {
            updateUI("Vicharu chu", "bg-blue-400");
            const length = document.getElementById('speechLength').value;
            
            const prompt = `Aap Tarun ji ki cute bachi dost hain. Reply Hinglish mein dein. 
            Aapne abhi browser commands handle karna seekha hai (YouTube, Google). 
            Jawab chota aur cute rakhein (max ${Math.floor(length/8)} words).`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{parts: [{text: input}]}],
                        systemInstruction: {parts: [{text: prompt}]},
                        generationConfig: {maxOutputTokens: parseInt(length), temperature: 0.7}
                    })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                playStableVoice(reply);
            } catch (e) {
                playStableVoice("Internet uncle slow che, fari bolo!");
            }
        }

        async function playStableVoice(text, retry = 0) {
            isSpeaking = true;
            updateUI("Bolye chu", "bg-pink-500");
            
            const display = document.getElementById('aiTextDisplay');
            display.innerText = text;
            display.style.opacity = "1";
            display.style.transform = "scale(1)";

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say this like a cute 5yr old girl: ${text}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: STABLE_VOICE } } }
                        }
                    })
                });

                if (!res.ok) throw new Error("API failed");
                const data = await res.json();
                const pcmData = data.candidates[0].content.parts[0].inlineData.data;
                const mime = data.candidates[0].content.parts[0].inlineData.mimeType;
                const sRate = parseInt(mime.match(/rate=(\d+)/)?.[1] || 24000);
                
                await playAudio(pcmData, sRate);

            } catch (err) {
                if (retry < 1) {
                    setTimeout(() => playStableVoice(text, retry + 1), 500);
                    return;
                }
                updateUI("Aawaj ma bhul che", "bg-red-500");
                cleanupTurn();
            }
        }

        async function playAudio(base64, rate) {
            const binary = atob(base64);
            const bytes = new Int16Array(binary.length / 2);
            for (let i = 0; i < binary.length; i += 2) {
                bytes[i / 2] = (binary.charCodeAt(i + 1) << 8) | binary.charCodeAt(i);
            }

            const buffer = audioContext.createBuffer(1, bytes.length, rate);
            buffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            
            document.getElementById('characterStage').classList.add('is-speaking');
            source.start();
            source.onended = () => cleanupTurn();
        }

        function cleanupTurn() {
            document.getElementById('characterStage').classList.remove('is-speaking');
            isSpeaking = false;
            if (isRunning) {
                setTimeout(() => { if(isRunning) recognizer.start(); }, 400);
            } else {
                updateUI("Standby", "bg-slate-600");
            }
        }

        function toggleMain() {
            if (audioContext.state === 'suspended') audioContext.resume();
            if (!isRunning) {
                isRunning = true;
                document.getElementById('micIcon').innerHTML = '<i data-lucide="square"></i>';
                document.querySelector('.control-panel').classList.add('glow-active');
                lucide.createIcons();
                recognizer.start();
            } else {
                isRunning = false;
                recognizer.stop();
                document.getElementById('micIcon').innerHTML = '<i data-lucide="mic"></i>';
                document.querySelector('.control-panel').classList.remove('glow-active');
                lucide.createIcons();
                updateUI("Standby", "bg-slate-600");
            }
        }

        function updateUI(t, c) {
            document.getElementById('stTxt').innerText = t;
            document.getElementById('dot').className = `w-1.5 h-1.5 rounded-full ${c}`;
        }

        window.onload = init;
    </script>
</body>
</html>
