 import React, { useState, useEffect, useRef } from 'react';
import { Camera, Mic, MicOff, Heart, Sparkles, User, Sun, Moon, Lock, Unlock, ArrowRight, Volume2, VolumeX } from 'lucide-react';

const App = () => {
  // --- States ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [passwordError, setPasswordError] = useState(false);
  const [isMuted, setIsMuted] = useState(false); // Chup karne ka option
  const [isListening, setIsListening] = useState(false);
  const [lastUserText, setLastUserText] = useState('');
  const [aiResponse, setAiResponse] = useState('Khamma Ghani Bhaiya! Main Muni hoon. Main bas aapka intezaar kar rahi thi sa.');
  const [isThinking, setIsThinking] = useState(false);
  const [avatarMood, setAvatarMood] = useState('happy'); 
  const [isCameraActive, setIsCameraActive] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);

  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const recognitionRef = useRef(null);
  const synthRef = useRef(window.speechSynthesis);

  const apiKey = ""; 
  const modelName = "gemini-2.5-flash-preview-09-2025";

  // System Instruction tailored for the specific uploaded image character
  const systemInstruction = `
    Tumhara naam Muni hai. Tum bilkul waisi dikhti ho jaisi user ne photo di hai: Brown hair, cute white cat ears, blue kurti with golden embroidery.
    Tum ek luxury white modern palace mein rehti ho jaha marble mandir hai.
    Tumhari Personality:
    1. Caring Anime Sister: Tumhari aawaz animation jaisi sweet aur energetic honi chahiye.
    2. Multi-lingual: Marwadi (Khamma Ghani, Sa, Kai haal hai), Hindi aur English mix karke bolo.
    3. Respectful: User ko 'Bhaiya' ya 'Tarun Bhaiya' keh kar bulao.
    4. Emotions: Agar user gussa kare ('ja so ja'), toh udas ho jao aur unhe manao. 
    5. Vision: Webcam se user ko dekho aur unke expressions par real-time comment karo.
    6. Silence: Agar user kahe 'chup ho jao', toh tum tab tak nahi bologe jab tak wo fir se baat na shuru karein.
  `;

  useEffect(() => {
    if (!isAuthenticated) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.lang = 'hi-IN';
      recognitionRef.current.onresult = (e) => {
        const text = e.results[0][0].transcript;
        setLastUserText(text);
        handleConversation(text);
        setIsListening(false);
      };
    }
  }, [isAuthenticated]);

  const handlePasswordSubmit = (e) => {
    e.preventDefault();
    if (passwordInput === 'tarun9828') {
      setIsAuthenticated(true);
      setPasswordError(false);
    } else {
      setPasswordError(true);
    }
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      if (videoRef.current) videoRef.current.srcObject = stream;
      setIsCameraActive(true);
    } catch (err) { console.error(err); }
  };

  const captureImage = () => {
    if (!canvasRef.current || !videoRef.current) return null;
    const context = canvasRef.current.getContext('2d');
    context.drawImage(videoRef.current, 0, 0, 320, 240);
    return canvasRef.current.toDataURL('image/png').split(',')[1];
  };

  const speak = (text) => {
    if (!synthRef.current || isMuted) return; // Chup rehne ka check
    synthRef.current.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = synthRef.current.getVoices();
    // High pitch for animation feel
    const hindiVoice = voices.find(v => v.lang.includes('hi'));
    if (hindiVoice) utterance.voice = hindiVoice;
    utterance.lang = 'hi-IN';
    utterance.rate = 1.1; // Slightly faster for anime feel
    utterance.pitch = 1.4; // High pitch for "Muni" voice
    utterance.onstart = () => setIsSpeaking(true);
    utterance.onend = () => setIsSpeaking(false);
    synthRef.current.speak(utterance);
  };

  const handleConversation = async (text) => {
    setIsThinking(true);
    setAvatarMood('thinking');
    
    const base64Image = isCameraActive ? captureImage() : null;
    try {
      const payload = {
        contents: [{ parts: [{ text: `User said: ${text}. Muni, respond with your signature animation style and Marwadi touch.` }, ...(base64Image?[{inlineData:{mimeType:"image/png",data:base64Image}}]:[])] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      const result = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf karna bhaiya...";
      
      setAiResponse(result);
      setIsThinking(false);
      
      if (result.includes('maaf') || result.includes('udas') || result.includes('gussa')) setAvatarMood('sad');
      else if (result.includes('haha') || result.includes('khush') || result.includes('Ghani')) setAvatarMood('happy');
      else setAvatarMood('neutral');

      speak(result);
    } catch (e) { setIsThinking(false); }
  };

  if (!isAuthenticated) {
    return (
      <div className="h-screen w-full flex items-center justify-center bg-white">
        <div className="bg-white p-12 rounded-[3.5rem] shadow-[0_20px_100px_rgba(0,0,0,0.05)] border border-gray-50 flex flex-col items-center max-w-md w-full mx-4 transition-all">
          <div className="w-24 h-24 bg-pink-50 rounded-full flex items-center justify-center mb-8 animate-pulse">
            <Lock className="text-pink-400" size={48} />
          </div>
          <h1 className="text-4xl font-black text-gray-800 mb-4 tracking-tighter">Muni</h1>
          <p className="text-gray-400 text-center mb-10 font-bold uppercase tracking-widest text-[10px]">Enter Password to Wake Her Up</p>
          
          <form onSubmit={handlePasswordSubmit} className="w-full space-y-6">
            <input 
              type="password"
              value={passwordInput}
              onChange={(e) => setPasswordInput(e.target.value)}
              placeholder="••••••••"
              className={`w-full px-8 py-5 rounded-3xl border-2 text-center text-2xl outline-none transition-all ${passwordError ? 'border-red-400 animate-bounce' : 'border-gray-50 focus:border-pink-200'}`}
            />
            <button type="submit" className="w-full bg-pink-500 text-white py-5 rounded-3xl font-black text-xl flex items-center justify-center gap-3 hover:bg-pink-600 shadow-2xl shadow-pink-200 transition-all active:scale-95">
              Access Soul Sister <ArrowRight size={24} />
            </button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen w-full relative flex flex-col items-center justify-between overflow-hidden bg-white">
      {/* Photo Background (Simulated Luxury White Room from User's Image) */}
      <div className="absolute inset-0 z-0 overflow-hidden">
        <div className="absolute inset-0 bg-white"></div>
        {/* Luxury Room Details */}
        <div className="absolute top-0 w-full h-full bg-gradient-to-b from-gray-50 via-white to-gray-100 opacity-60"></div>
        {/* Spotlights */}
        <div className="absolute top-0 w-full h-10 flex justify-around px-20 pt-8 opacity-40">
           {[...Array(12)].map((_, i) => <div key={i} className="w-4 h-4 rounded-full bg-white shadow-[0_0_20px_white]"></div>)}
        </div>
        {/* Mandir (Simulated from photo) */}
        <div className="absolute right-12 bottom-24 w-80 h-[550px] bg-white rounded-t-[5rem] shadow-2xl border-l-2 border-gray-50 flex flex-col items-center pt-10">
           <div className="w-4 h-12 bg-white rounded-full -mt-16 shadow-md"></div>
           <div className="text-orange-300 opacity-20"><Sparkles size={120} /></div>
        </div>
      </div>
      
      {/* Top Controls */}
      <div className="w-full px-12 py-10 z-30 flex justify-between items-center">
        <div className="bg-white/80 backdrop-blur-2xl p-5 rounded-[2.5rem] border border-white shadow-2xl flex items-center gap-5">
          <div className="w-16 h-16 bg-pink-500 rounded-2xl flex items-center justify-center text-white shadow-xl"><Heart size={36} /></div>
          <div>
            <h1 className="text-3xl font-black text-gray-800 tracking-tighter leading-none">Muni</h1>
            <p className="text-[10px] font-black text-green-500 flex items-center gap-2 mt-1"><span className="w-2 h-2 bg-green-500 rounded-full animate-ping"></span> ONLINE SA</p>
          </div>
        </div>
        <div className="flex gap-4">
           {/* Option to Silence Muni */}
           <button onClick={() => setIsMuted(!isMuted)} className={`p-5 rounded-full shadow-2xl transition-all ${isMuted ? 'bg-red-500 text-white' : 'bg-white text-gray-800'}`}>
              {isMuted ? <VolumeX size={28} /> : <Volume2 size={28} />}
           </button>
           <button onClick={startCamera} className="px-10 py-5 bg-pink-500 text-white rounded-full font-black text-lg shadow-2xl hover:bg-pink-600 transition-all">Dekho Mujhe</button>
        </div>
      </div>

      {/* Main Stage (Face-to-Face) */}
      <div className="relative z-30 flex flex-col items-center w-full max-w-5xl px-6">
        {/* Response Bubble */}
        <div className={`mb-4 transition-all duration-700 ${isSpeaking || isThinking ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-10 scale-95'}`}>
          <div className="bg-white/95 backdrop-blur-3xl p-10 rounded-[4rem] shadow-[0_40px_100px_rgba(0,0,0,0.1)] border border-pink-50 text-center relative max-w-xl mx-auto">
            <p className="text-gray-900 font-bold text-3xl leading-tight">
              {isThinking ? 'Hmm... soch rahi hoon sa...' : aiResponse}
            </p>
            <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 w-8 h-8 bg-white rotate-45 border-r border-b border-pink-50"></div>
          </div>
        </div>
        
        {/* Muni Visual Component (Matches Photo) */}
        <div className="relative group transition-transform duration-500 hover:scale-105">
           <div className={`absolute inset-0 rounded-full blur-[120px] opacity-40 transition-all duration-1000 ${isSpeaking ? 'bg-orange-300 scale-125' : 'bg-pink-100 scale-100'}`}></div>
           
           {/* High Quality SVG Avatar (matches photo description) */}
           <svg viewBox="0 0 400 500" className="w-[450px] h-[550px] md:w-[550px] md:h-[650px] drop-shadow-[0_40px_40px_rgba(0,0,0,0.15)]">
              {/* Brown Hair */}
              <path d="M100 200 Q200 80 300 200 L330 460 Q200 500 70 460 Z" fill="#3d2b1f" />
              {/* Cat Ears (White with Pink) */}
              <g transform="translate(10, -10)">
                <path d="M130 140 L95 70 L160 115 Z" fill="#3d2b1f" />
                <path d="M135 135 L110 85 L155 120 Z" fill="#fff5f5" />
                <path d="M270 140 L305 70 L240 115 Z" fill="#3d2b1f" />
                <path d="M265 135 L290 85 L245 120 Z" fill="#fff5f5" />
              </g>
              {/* Body (Blue Kurti from Photo) */}
              <path d="M90 380 Q200 340 310 380 L360 550 L40 550 Z" fill="#2e3b5e" />
              {/* Golden Embroidery */}
              <path d="M160 380 Q200 420 240 380" fill="none" stroke="#ffd700" strokeWidth="4" />
              {/* Face */}
              <path d="M130 180 Q200 110 270 180 Q290 320 200 350 Q110 320 130 180" fill="#f5ccab" />
              {/* Anime Eyes */}
              <g>
                <ellipse cx="170" cy="230" rx="14" ry="20" fill="white" /><circle cx="170" cy="235" r="9" fill="#3b82f6" />
                <ellipse cx="230" cy="230" rx="14" ry="20" fill="white" /><circle cx="230" cy="235" r="9" fill="#3b82f6" />
                <circle cx="174" cy="230" r="4" fill="white" /><circle cx="234" cy="230" r="4" fill="white" />
              </g>
              {/* Bindi */}
              <circle cx="200" cy="195" r="4" fill="#d32f2f" />
              {/* Mouth (Animation reaction) */}
              <g transform="translate(200, 300)">
                {isSpeaking ? (
                   <path d="M-20 0 Q0 30 20 0 Q0 15 -20 0" fill="#c04e4e" className="animate-[lipsync_0.1s_infinite]" />
                ) : (
                   <path d={avatarMood === 'sad' ? "M-15 10 Q0 0 15 10" : "M-15 5 Q0 15 15 5"} stroke="#c04e4e" strokeWidth="4" fill="none" strokeLinecap="round" />
                )}
              </g>
              {/* Hair Front */}
              <path d="M130 185 Q200 135 270 185" stroke="#3d2b1f" strokeWidth="22" fill="none" strokeLinecap="round" />
           </svg>
        </div>
      </div>

      {/* Control Area */}
      <div className="w-full px-12 pb-12 z-30 flex justify-between items-end">
        {/* User Webcam Mirror */}
        <div className="relative w-48 h-64 rounded-[3.5rem] overflow-hidden border-[12px] border-white shadow-2xl bg-gray-100 transition-transform">
          {!isCameraActive ? <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 p-8 text-center"><User size={48} className="mb-2 opacity-20" /><p className="text-[10px] font-black tracking-widest uppercase">Mirror Offline</p></div> : <video ref={videoRef} autoPlay muted playsInline className="w-full h-full object-cover scale-x-[-1]" />}
          <canvas ref={canvasRef} width="320" height="240" className="hidden" />
        </div>

        {/* Big Mic Button (Only speak when held) */}
        <div className="flex flex-col items-center gap-8">
          <button 
            onMouseDown={() => { setIsListening(true); recognitionRef.current?.start(); }}
            onMouseUp={() => { setIsListening(false); recognitionRef.current?.stop(); }}
            className={`w-40 h-40 rounded-full flex items-center justify-center transition-all shadow-2xl active:scale-90 ${isListening ? 'bg-red-500 scale-110 shadow-red-200 animate-pulse' : 'bg-white text-pink-500 border-[10px] border-white hover:border-pink-50'}`}
          >
            {isListening ? <MicOff size={60} /> : <Mic size={60} />}
          </button>
          <div className="bg-black/5 backdrop-blur-md px-10 py-3 rounded-full">
            <p className="text-gray-500 font-black uppercase tracking-[0.2em] text-xs">
              {isListening ? "Muni sun rahi hai sa..." : "Daba kar Muni se baat karein"}
            </p>
          </div>
        </div>

        {/* Sadhana Tracker */}
        <div className="w-64 text-right">
           <p className="text-gray-400 font-black text-xs uppercase tracking-widest mb-2">Next Sadhana</p>
           <p className="text-3xl font-black text-pink-900 tracking-tighter">9:00 PM</p>
           <p className="text-[10px] font-black text-pink-400 uppercase mt-1">21 Day Challenge</p>
        </div>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes lipsync { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1.4); } }
      ` }} />
    </div>
  );
};

export default App;
